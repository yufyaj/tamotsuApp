const { ApiGatewayManagementApiClient, PostToConnectionCommand } = require("@aws-sdk/client-apigatewaymanagementapi");

// アクセストークンの検証
async function deliveryContent(connection, receiverIds, sendData) {
    try{
        const client = new ApiGatewayManagementApiClient({
            endpoint: "https://" + process.env.MY_WS_DOMAIN + "/"
        })

        for (const receiverId of receiverIds) {
            const [ connectionIdRows ] = await connection.execute("SELECT connection_id FROM connections WHERE connector_id = ?", [receiverId]);
            if (connectionIdRows.length > 0) {
                // WebSocket通信を確立している人がいる場合
                const connectionId = connectionIdRows[0].connection_id;
                const command      = new PostToConnectionCommand({
                    ConnectionId: connectionId,
                    Data: JSON.stringify(sendData)
                });
                try {
                    await client.send(command);
                    return;
                } catch (err) {
                    if (err.name === 'GoneException') {
                        console.log(`Stale connection, deleting ${connectionId}`);
                        await connection.execute("DELETE FROM connections WHERE connectionId = ?", [connectionId]);
                    } else {
                        console.log(`Failed to post. Error: ${JSON.stringify(err)}`);
                    }
                }         
            }
            
            // WebSocket通信を確立している人がいない場合
        }
    } catch(error) {
        console.log('error : ', error);
        throw error;
    }
}

module.exports = { deliveryContent };