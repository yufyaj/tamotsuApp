const { S3Client, GetObjectCommand } = require("@aws-sdk/client-s3");
const { Buffer } = require('buffer');

const s3Client = new S3Client({ region: process.env.MY_REGION });

async function getBase64Image(bucketName, key) {
    try {
        const command = new GetObjectCommand({
            Bucket: bucketName,
            Key: key
        });

        const response = await s3Client.send(command);
        const imageData = await streamToBuffer(response.Body);

        // Base64エンコード
        return imageData.toString('base64');
    } catch (error) {
        console.error('Error fetching image from S3:', error);
        throw new Error('画像の取得に失敗しました');
    }
}

function streamToBuffer(stream) {
    return new Promise((resolve, reject) => {
        const chunks = [];
        stream.on('data', (chunk) => chunks.push(chunk));
        stream.on('end', () => resolve(Buffer.concat(chunks)));
        stream.on('error', reject);
    });
}

module.exports = {
    getBase64Image,
}